using HarmonyLib;
using OCEAdmin.Core.Plugin;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Threading.Tasks;
using TaleWorlds.MountAndBlade;

namespace OCEAdmin.Plugins.NameExploitFix
{
    public class NameExploitFixPlugin : PluginBase
    {
        public override string Name => "Name Exploit Fix";
        public override string Description => "Fixes an issue with concatenation of names with weird ASCII prefixes causing C# bugs when names are not sanitised.";
        public override bool IsCore => false;
        public NameExploitFixPlugin() { }

        public override async Task Load()
        {
            await base.Load();
        }

        public override void OnPatch(Harmony harmony)
        {
            base.OnPatch(harmony);

            var original = typeof(GameNetwork).GetMethod("AddNewPlayerOnServer", BindingFlags.Public | BindingFlags.Static);
            var prefix = typeof(NamePatchAddNewPlayerOnServer).GetMethod("Prefix");
            harmony.Patch(original, prefix: new HarmonyMethod(prefix));
        }
    }
}
